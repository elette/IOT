<!DOCTYPE HTML>
<html>
  <head>
    <title>InfoSphere REST API Sample - View Data</title>

    <link rel="stylesheet" href="dojo/dojo/resources/dojo.css" />
    <link rel="stylesheet" href="dojo/dijit/themes/claro/claro.css" />
    <link rel="stylesheet" href="dojo/dojox/grid/resources/Grid.css" />
 
    <script src="dojo/dojo/dojo.js"></script>

    <script type="text/javascript">	
      require(["dojox/charting/Chart",
               "dojox/charting/themes/Claro",
               "dojox/charting/plot2d/Lines",
               "dojox/charting/StoreSeries",
               "dojox/charting/action2d/Tooltip", 
               "dojox/charting/plot2d/Pie",
               "dojox/grid/DataGrid",
               "dojo/store/Observable",
               "dojo/store/Memory",
               "dojo/data/ObjectStore",
               "dojox/charting/widget/Legend",
               "dojox/charting/plot2d/Markers",
               "dojox/charting/axis2d/Default",	
               "dojo/domReady!"], 
      function(Chart, theme, LinesPlot, Memory, StoreSeries, ObjectStore){      
        var Sensor = "ACC_Y";
        dojoCharts = new DojoCharts(Chart, theme, LinesPlot, Memory, StoreSeries, ObjectStore, Sensor);
        drawDojoCharts(Memory, StoreSeries, ObjectStore, Sensor);
      });

      function drawDojoCharts(Memory, StoreSeries, ObjectStore, Sensor){
       // Get latest data 
       //var response = getFormattedViewData();
       //dojoCharts.lineData = response.text();
       //dojoCharts.lineData = dojo.store.Observable(new dojo.store.Memory({data:{label:"A",items:response}}));
//console.log(">>>\n" + response);
       //dojoCharts.lineData = dojo.store.Observable(new dojo.store.Memory({data:response}));
       //dojoCharts.lineSeries = new dojox.charting.StoreSeries(dojoCharts.lineData, {query: {"DEVICE_ID":"0003-0004", "SENSOR_ID":"CO2"}}, { y:"CUR_VALUE"});
       //dojoCharts.lineSeries = new dojox.charting.StoreSeries(dojoCharts.lineData, {query: {}}, "CUR_VALUE");
       dojoCharts.draw(Memory, StoreSeries, ObjectStore, Sensor);
       setTimeout(function () {drawDojoCharts(Memory, StoreSeries, ObjectStore, Sensor);}, 10000);
      };

      DojoCharts.prototype.draw = function(Memory, StoreSeries, ObjectStore, Sensor) {
        var response = getFormattedViewData();
        this.lineData = dojo.store.Observable(new dojo.store.Memory({data:response}));
        var lineSeries = this.lineChart.series;
        for (var i=0; i<lineSeries.length; i++) {
          this.lineChart.updateSeries(lineSeries[i].name,  new dojox.charting.StoreSeries(this.lineData, {query: {"DEVICE_ID":lineSeries[i].name, "SENSOR_ID":Sensor}}, { y: "CUR_VALUE" }));
        }
        this.lineChart.render();
//console.log(">>> "+typeof(this.lineSeries));
      };

      function DojoCharts(Chart, theme, LinesPlot, Memory, StoreSeries, ObjectStore, Sensor) {
        // Retrieve the view data
        var response = getFormattedViewData();
        //this.lineData = dojo.store.Observable(new dojo.store.Memory({data:{label:"A",items:response}}));
        this.lineData = dojo.store.Observable(new dojo.store.Memory({data:response}));

        // Create the line chart
        this.lineChart = new Chart("lineChart", { title: "Current", titlePos: "top"});
        this.lineChart.setTheme(theme);
        this.lineChart.addPlot("default", {type: "Lines",	markers: true, });
        this.lineChart.addAxis("x",{labelFunc:formatTimeLabel, fixLower: "none", fixUpper: "none", rotation: -45});//,  dropLabels: false });
        //this.lineChart.addAxis("x",{fixLower: "none", fixUpper: "none", rotation: -45,  dropLabels: false });
        this.lineChart.addAxis("y", { vertical: true, fixLower: "minor", fixUpper: "major" });
        var lineSeries;
        lineSeries = new dojox.charting.StoreSeries(this.lineData, {query: {"DEVICE_ID":"0003-0004", "SENSOR_ID":Sensor}}, { y: "CUR_VALUE" });
        this.lineChart.addSeries("0003-0004", lineSeries) ;
        lineSeries = new dojox.charting.StoreSeries(this.lineData, {query: {"DEVICE_ID":"0003-0005", "SENSOR_ID":Sensor}}, { y: "CUR_VALUE" });
        this.lineChart.addSeries("0003-0005", lineSeries) ;
        lineSeries = new dojox.charting.StoreSeries(this.lineData, {query: {"DEVICE_ID":"0003-0006", "SENSOR_ID":Sensor}}, { y: "CUR_VALUE" });
        this.lineChart.addSeries("0003-0006", lineSeries) ;
        lineSeries = new dojox.charting.StoreSeries(this.lineData, {query: {"DEVICE_ID":"0003-0007", "SENSOR_ID":Sensor}}, { y: "CUR_VALUE" });
        this.lineChart.addSeries("0003-0007", lineSeries) ;
        //this.lineTooltip = new Tooltip(this.lineChart, "default");
        this.lineChart.render();
        var legend = new dojox.charting.widget.Legend({chart: this.lineChart, horizontal: false}, "legend");
        //this.lineSeries.fetch();

      }

      function getFormattedViewData() {
        var httpRequest = new XMLHttpRequest();
        httpRequest.open("GET","data",false);
        httpRequest.send();
        return JSON.parse( httpRequest.responseText );  
/*
        dojo.xhrGet({
          url: "data",
          sync: true,
          handleAs: "json"
        }).then(function(jsondata){return jsondata;});
*/
      }

      function formatTimeLabel(timeValue) {
        var dt = new Date(Date.parse(timeValue.replace(" ","T")));
        //var dt = new Date();
        //dt.setTime(timeValue);
        var millis = dt.getMilliseconds();
        if (millis == 0) {
          millis = "000";
        }
        //return (dt.getHours()+1) + ":" + dt.getMinutes() + ":" + dt.getSeconds() + "." + millis;
        return (dt.getTime());
        //return (dt.getMonth() + 1) + "/" + dt.getDate();
      }

    </script>
  </head>

  <body>
    <h1>InfoSphere Streams Sample REST Application</h1><p>
    <table cellpadding="0" cellspacing="0">
      <tr><td id="lineChart" width="600" height="400"></td><td id="legend"></td></tr>
    </table>
  </body>
</html>
